<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>999 RADIO — Swipe Edition</title>
<script src="https://cdn.tailwindcss.com"></script>
<style>
@keyframes gradient {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}
body {
  background: linear-gradient(-45deg,#000,#13071f,#050505,#1e0735);
  background-size: 400% 400%;
  animation: gradient 15s ease infinite;
  height: 100vh; margin: 0; overflow: hidden;
  color: white; font-family: sans-serif;
  display: flex; align-items: center; justify-content: center;
  touch-action: none;
}
.glass {
  background: rgba(255,255,255,0.03);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: 3rem;
  border: 1px solid rgba(255,255,255,0.1);
  z-index: 10;
  position: relative;
  pointer-events: none;
}
#rainCanvas {
  position: absolute;
  top: 0; left: 0; width: 100%; height: 100%;
  z-index: 50;
  pointer-events: auto;
}
.retro-font { font-family: 'Courier New', Courier, monospace; }
</style>
</head>
<body>

<canvas id="rainCanvas"></canvas>

<div class="glass w-[92%] max-w-sm h-[80vh] p-8 flex flex-col justify-between items-center text-center">
  <div class="w-full">
    <div id="era-badge" class="inline-block bg-purple-600 text-[10px] font-black px-4 py-1.5 rounded-full uppercase tracking-widest mb-2 opacity-0 transition-all">
      LOADING...
    </div>
    <h1 id="title" class="text-2xl font-black truncate px-2">999 Inferno</h1>
    <p id="album" class="text-purple-400/50 text-xs italic mt-1">Sintonizando...</p>
  </div>

  <div class="relative flex items-center justify-center w-full grow">
    <canvas id="mainCanvas" width="350" height="350"></canvas>
  </div>

  <div id="eq" class="flex items-end justify-center gap-1.5 h-16 w-full px-4 mb-8"></div>

  <div class="w-full">
    <div class="relative w-full bg-white/5 h-1 rounded-full overflow-hidden mb-6">
      <div id="progress" class="absolute top-0 left-0 bg-purple-500 h-full w-0 transition-all"></div>
    </div>
    <div class="flex justify-between items-center px-2 py-2 border-t border-white/10 retro-font text-[10px]">
      <div class="text-purple-400">HIGH: <span id="score-val" class="text-white text-xs">000000</span></div>
      <div class="text-yellow-500">BEST: <span id="best-val" class="text-white text-xs">000000</span></div>
    </div>
    <p class="text-[8px] text-white/20 mt-2 uppercase tracking-widest italic">Desliza horizontal para pasar tema</p>
  </div>
</div>

<audio id="audio" crossorigin="anonymous"></audio>

<script>
const rainCanvas = document.getElementById("rainCanvas");
const rainCtx = rainCanvas.getContext("2d");
const mainCanvas = document.getElementById("mainCanvas");
const mainCtx = mainCanvas.getContext("2d");
const audio = document.getElementById("audio");

let colorMain = "#a855f7";
let pulse = 0, flashEffect = 0;
let items = [];
let currentScore = 0;

/* --- SWIPE ENGINE --- */
let touchStartX = 0;
let touchStartY = 0;

/* --- SCORE LOGIC --- */
let bestScore = localStorage.getItem("999_best_score") || 0;
document.getElementById("best-val").innerText = bestScore.toString().padStart(6, '0');

function addScore(pts) {
    currentScore += pts;
    document.getElementById("score-val").innerText = currentScore.toString().padStart(6, '0');
    if(currentScore > bestScore) {
        bestScore = currentScore;
        localStorage.setItem("999_best_score", bestScore);
        document.getElementById("best-val").innerText = bestScore.toString().padStart(6, '0');
    }
}
setInterval(() => { if(!audio.paused) addScore(1); }, 1000);

/* --- LLUVIA --- */
function resize() { rainCanvas.width = window.innerWidth; rainCanvas.height = window.innerHeight; }
window.addEventListener('resize', resize);
resize();

class RainItem {
    constructor(type) {
        this.type = type;
        this.x = Math.random() * rainCanvas.width;
        this.y = -50;
        this.speed = 2 + Math.random() * 2;
        this.angle = Math.random() * Math.PI * 2;
        this.rotSpeed = (Math.random() - 0.5) * 0.1;
        this.dying = false; this.opacity = 1; this.state = 'full';
    }
    draw(ctx) {
        ctx.save(); ctx.translate(this.x, this.y); ctx.rotate(this.angle); ctx.globalAlpha = this.opacity;
        if(this.type === 'cup') {
            ctx.fillStyle = "#fff"; ctx.beginPath(); ctx.moveTo(-10, -15); ctx.lineTo(10, -15); ctx.lineTo(7, 15); ctx.lineTo(-7, 15); ctx.fill();
            if(this.state === 'full') { ctx.fillStyle = colorMain; ctx.fillRect(-8, -12, 16, 6); }
        } else {
            ctx.fillStyle = "#3b82f6"; ctx.beginPath(); ctx.roundRect(-10, -5, 20, 10, 5); ctx.fill();
            ctx.fillStyle = "rgba(255,255,255,0.4)"; ctx.fillRect(0, -5, 10, 10);
        }
        ctx.restore();
    }
    update() { this.y += this.speed; this.angle += this.rotSpeed; if(this.dying) this.opacity -= 0.1; }
}

setInterval(() => { if(items.length < 15) items.push(new RainItem(Math.random() > 0.4 ? 'cup' : 'pill')); }, 700);

/* --- GESTOS E INTERACCIÓN --- */
rainCanvas.addEventListener('touchstart', (e) => {
    touchStartX = e.touches[0].clientX;
    touchStartY = e.touches[0].clientY;
    handleTap(e.touches[0]);
}, {passive: true});

rainCanvas.addEventListener('touchend', (e) => {
    let touchEndX = e.changedTouches[0].clientX;
    let touchEndY = e.changedTouches[0].clientY;
    
    let diffX = touchEndX - touchStartX;
    let diffY = touchEndY - touchStartY;

    if (Math.abs(diffX) > 60 && Math.abs(diffX) > Math.abs(diffY)) {
        nextSong();
    }
}, {passive: true});

rainCanvas.addEventListener('mousedown', (e) => {
    touchStartX = e.clientX;
    handleTap(e);
});
rainCanvas.addEventListener('mouseup', (e) => {
    let diffX = e.clientX - touchStartX;
    if (Math.abs(diffX) > 60) nextSong();
});

function handleTap(pos) {
    items.forEach(item => {
        const dx = pos.clientX - item.x;
        const dy = pos.clientY - item.y;
        if(Math.sqrt(dx*dx + dy*dy) < 50 && !item.dying) {
            item.dying = true;
            if(item.type === 'cup') { item.state = 'empty'; flashEffect = 1.0; addScore(100); }
            else { addScore(50); }
        }
    });
}

/* --- ANIMACIÓN --- */
function animate() {
    rainCtx.clearRect(0,0, rainCanvas.width, rainCanvas.height);
    items.forEach((item, i) => {
        item.update(); item.draw(rainCtx);
        if(item.y > rainCanvas.height + 50 || item.opacity <= 0) items.splice(i, 1);
    });

    mainCtx.clearRect(0,0,350,350);
    pulse = !audio.paused ? (0.5 + Math.abs(Math.sin(Date.now() * 0.01)) * 0.5) : (pulse * 0.9);
    mainCtx.save(); mainCtx.translate(175, 175);
    const scale = (1 + (pulse * 0.2)) + (flashEffect * 0.3);
    mainCtx.scale(scale, scale);
    const grd = mainCtx.createRadialGradient(0,0,10,0,0,160);
    grd.addColorStop(0, colorMain + "44"); grd.addColorStop(1, "transparent");
    mainCtx.fillStyle = grd; mainCtx.fillRect(-175, -175, 350, 350);
    mainCtx.shadowColor = colorMain; mainCtx.shadowBlur = 20 + (flashEffect * 30);
    mainCtx.fillStyle = flashEffect > 0.1 ? colorMain : "#fff";
    mainCtx.font = "900 130px Arial Black"; mainCtx.textAlign = "center"; mainCtx.textBaseline = "middle";
    mainCtx.fillText("999", 0, 0); mainCtx.restore();
    if(flashEffect > 0) flashEffect -= 0.05;
    requestAnimationFrame(animate);
}
animate();

/* --- AUDIO LOGIC CON CORS PROXY --- */
const PROXY = "https://api.allorigins.win/raw?url=";
const API = "https://juicewrldapi.com/juicewrld";

async function nextSong() {
    try {
        const r = await fetch(`${PROXY}${encodeURIComponent(API + "/radio/random/")}`);
        const d = await r.json();
        const s = d.song || d;
        
        document.getElementById("title").innerText = s.name || "Unknown";
        document.getElementById("album").innerText = s.album || "999 Forever";
        
        let era = s.era ? (typeof s.era === 'string' ? s.era : s.era.name) : "Unreleased";
        const eras = {"GBGR": "#22c55e", "DRFL": "#3b82f6", "WOD": "#ef4444", "Unreleased": "#a855f7"};
        colorMain = eras[era] || "#a855f7";
        
        const badge = document.getElementById("era-badge");
        badge.innerText = era; 
        badge.style.backgroundColor = colorMain; 
        badge.classList.remove("opacity-0");
        document.getElementById("progress").style.backgroundColor = colorMain;
        
        // Direct audio URL (sin proxy para audio streaming)
        audio.src = `${API}/files/download/?path=${encodeURIComponent(s.path)}`;
        audio.play().catch((err) => {
            console.log("Audio play error:", err);
        });
    } catch(e) { 
        console.error("Error loading song:", e);
        setTimeout(nextSong, 2000); 
    }
}

const eq = document.getElementById("eq");
for(let i=0; i<15; i++) eq.innerHTML += `<div class="flex-1 bg-white/10 rounded-t-full"></div>`;
setInterval(() => {
    eq.querySelectorAll('div').forEach((b, i) => {
        const h = audio.paused ? 10 : (20 + Math.abs(Math.sin(Date.now()/150 + i)) * 80);
        b.style.height = h + "%"; b.style.backgroundColor = colorMain;
    });
}, 60);

audio.ontimeupdate = () => { if(audio.duration) document.getElementById("progress").style.width = (audio.currentTime/audio.duration)*100 + "%"; };
audio.onended = nextSong;
nextSong();
</script>
</body>
</html>
